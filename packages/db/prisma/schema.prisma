generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

enum HealthStatus {
  RED
  YELLOW
  GREEN
}

enum RoadmapStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  AT_RISK
}

enum SyncStatus {
  idle
  syncing
  error
}

enum StatsPeriod {
  all_time
  ytd
}

enum Trend {
  up
  down
  stable
}

enum ProjectStatus {
  ACTIVE
  PAUSED
  ARCHIVED
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  githubUrl   String?  @map("github_url")
  gitlabUrl   String?  @map("gitlab_url")
  imageUrl    String?  @map("image_url")
  parentId    String?  @map("parent_id")
  parent      Project? @relation("ProjectHierarchy", fields: [parentId], references: [id])
  children    Project[] @relation("ProjectHierarchy")
  fundedById  String?  @map("funded_by_id")
  fundedBy    Project? @relation("ProjectFunding", fields: [fundedById], references: [id])
  fundedProjects Project[] @relation("ProjectFunding")
  status      ProjectStatus @default(ACTIVE)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  healthAssessments HealthAssessment[]
  teams             Team[]
  teamMembers      TeamMember[]
  milestones       Milestone[]
  quarterlyGoals   QuarterlyGoal[]
  links            ProjectLink[]
  arrangements     TeamArrangement[]
  githubSync       GitHubSync?
  contributorStats ContributorStats[]
  favoritedBy      FavoriteProject[]
  owners           ProjectOwner[]

  @@index([parentId])
  @@index([fundedById])
  @@map("projects")
}

model Department {
  id     String   @id @default(cuid())
  name   String   @unique
  color  String?
  people Person[]
  titles Title[]

  @@map("roles")
}

model Team {
  id          String           @id @default(cuid())
  name        String
  description String?
  imageUrl    String?          @map("image_url")
  projectId   String           @map("project_id")
  project     Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  memberships TeamMembership[]

  arrangementTeam ArrangementTeam?

  @@index([projectId])
  @@map("teams")
}

model HealthAssessment {
  id        String       @id @default(cuid())
  projectId String       @map("project_id")
  project   Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  authorId  String       @map("author_id")

  overallStatus HealthStatus @map("overall_status")
  overallNotes  Json?        @map("overall_notes")

  growthStatus             HealthStatus? @map("growth_status")
  growthNotes              Json?         @map("growth_notes")
  marginStatus             HealthStatus? @map("margin_status")
  marginNotes              Json?         @map("margin_notes")
  longevityStatus          HealthStatus? @map("longevity_status")
  longevityNotes           Json?         @map("longevity_notes")
  clientSatisfactionStatus HealthStatus? @map("client_satisfaction_status")
  clientSatisfactionNotes  Json?         @map("client_satisfaction_notes")

  engineeringVibeStatus HealthStatus? @map("engineering_vibe_status")
  engineeringVibeNotes  Json?         @map("engineering_vibe_notes")
  productVibeStatus     HealthStatus? @map("product_vibe_status")
  productVibeNotes      Json?         @map("product_vibe_notes")
  designVibeStatus      HealthStatus? @map("design_vibe_status")
  designVibeNotes       Json?         @map("design_vibe_notes")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([projectId])
  @@map("health_assessments")
}

model Title {
  id           String      @id @default(cuid())
  name         String      @unique
  sortOrder    Int         @default(0) @map("sort_order")
  departmentId String?     @map("department_id")
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  people       Person[]

  @@map("titles")
}

model Person {
  id             String   @id @default(cuid())
  firstName      String   @map("first_name")
  lastName       String   @map("last_name")
  callsign       String?
  email          String   @unique
  githubUsername  String?  @map("github_username")
  gitlabUsername  String?  @map("gitlab_username")
  imageUrl       String?  @map("image_url")
  clerkUserId    String?  @unique @map("clerk_user_id")
  managerId      String?  @map("manager_id")
  manager        Person?  @relation("PersonManager", fields: [managerId], references: [id], onDelete: SetNull)
  directReports  Person[] @relation("PersonManager")
  departmentId   String?  @map("role_id")
  department     Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  titleId        String?  @map("title_id")
  title          Title?   @relation(fields: [titleId], references: [id], onDelete: SetNull)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  projectMemberships    TeamMember[]
  managerChanges        ManagerChange[] @relation("PersonManagerChanges")
  oldManagerOfChanges   ManagerChange[] @relation("OldManagerChanges")
  newManagerOfChanges   ManagerChange[] @relation("NewManagerChanges")
  meetings              Meeting[]
  comments              PersonComment[] @relation("PersonComments")
  authoredComments      PersonComment[] @relation("PersonCommentAuthors")
  milestoneAssignments      MilestoneAssignment[]
  quarterlyGoalAssignments  QuarterlyGoalAssignment[]
  visibilityGrantsGiven    MeetingVisibilityGrant[] @relation("GrantedVisibility")
  visibilityGrantsReceived MeetingVisibilityGrant[] @relation("ReceivedVisibility")
  favoriteProjects         FavoriteProject[]
  ownedProjects            ProjectOwner[]
  pendingInvites           PendingInvite[]
  goals                    PersonGoal[]
  accomplishments          PersonAccomplishment[]

  @@index([managerId])
  @@index([departmentId])
  @@index([titleId])
  @@map("people")
}

model ManagerChange {
  id           String   @id @default(cuid())
  personId     String   @map("person_id")
  person       Person   @relation("PersonManagerChanges", fields: [personId], references: [id], onDelete: Cascade)
  oldManagerId String?  @map("old_manager_id")
  oldManager   Person?  @relation("OldManagerChanges", fields: [oldManagerId], references: [id])
  newManagerId String?  @map("new_manager_id")
  newManager   Person?  @relation("NewManagerChanges", fields: [newManagerId], references: [id])
  changedBy    String   @map("changed_by")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([personId])
  @@map("manager_changes")
}

model TeamMember {
  id        String  @id @default(cuid())
  personId  String  @map("person_id")
  person    Person  @relation(fields: [personId], references: [id], onDelete: Cascade)
  projectId String  @map("project_id")
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  teamMemberships        TeamMembership[]
  arrangementAssignments ArrangementAssignment[]

  @@unique([personId, projectId])
  @@index([projectId])
  @@index([personId])
  @@map("team_members")
}

model TeamMembership {
  id           String     @id @default(cuid())
  teamId       String     @map("team_id")
  team         Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamMemberId String     @map("team_member_id")
  teamMember   TeamMember @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@unique([teamId, teamMemberId])
  @@map("team_memberships")
}

model Milestone {
  id          String        @id @default(cuid())
  title       String
  description String?
  targetDate  DateTime?     @map("target_date")
  status      RoadmapStatus @default(NOT_STARTED)
  sortOrder   Int           @default(0) @map("sort_order")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  projectId   String        @map("project_id")
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentId    String?       @map("parent_id")
  parent      Milestone?    @relation("MilestoneHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Milestone[]   @relation("MilestoneHierarchy")
  assignments MilestoneAssignment[]
  keyResults  KeyResult[]

  @@index([projectId])
  @@index([parentId])
  @@map("milestones")
}

model QuarterlyGoal {
  id          String        @id @default(cuid())
  title       String
  description String?
  quarter     String?
  targetDate  DateTime?     @map("target_date")
  status      RoadmapStatus @default(NOT_STARTED)
  sortOrder   Int           @default(0) @map("sort_order")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  projectId   String        @map("project_id")
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  parentId    String?       @map("parent_id")
  parent      QuarterlyGoal?  @relation("GoalHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    QuarterlyGoal[] @relation("GoalHierarchy")
  assignments QuarterlyGoalAssignment[]
  keyResults  KeyResult[]

  @@index([projectId])
  @@index([parentId])
  @@map("quarterly_goals")
}

model ProjectLink {
  id        String   @id @default(cuid())
  label     String
  url       String
  tags      String[] @default([])
  projectId String   @map("project_id")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("project_links")
}

model TeamArrangement {
  id        String   @id @default(cuid())
  name      String
  isActive  Boolean  @default(false) @map("is_active")
  projectId String   @map("project_id")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  teams ArrangementTeam[]

  @@index([projectId])
  @@map("team_arrangements")
}

model ArrangementTeam {
  id            String          @id @default(cuid())
  name          String
  arrangementId String          @map("arrangement_id")
  arrangement   TeamArrangement @relation(fields: [arrangementId], references: [id], onDelete: Cascade)
  sortOrder     Int             @default(0) @map("sort_order")
  liveTeamId    String?         @unique @map("live_team_id")
  liveTeam      Team?           @relation(fields: [liveTeamId], references: [id], onDelete: SetNull)

  assignments ArrangementAssignment[]

  @@index([arrangementId])
  @@map("arrangement_teams")
}

model ArrangementAssignment {
  id                String          @id @default(cuid())
  arrangementTeamId String          @map("arrangement_team_id")
  arrangementTeam   ArrangementTeam @relation(fields: [arrangementTeamId], references: [id], onDelete: Cascade)
  teamMemberId      String          @map("team_member_id")
  teamMember        TeamMember      @relation(fields: [teamMemberId], references: [id], onDelete: Cascade)

  @@unique([arrangementTeamId, teamMemberId])
  @@map("arrangement_assignments")
}

model GitHubSync {
  id         String     @id @default(cuid())
  projectId  String     @unique @map("project_id")
  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  lastSyncAt DateTime?  @map("last_sync_at")
  syncStatus SyncStatus @default(idle) @map("sync_status")
  syncError  String?    @map("sync_error")
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")

  @@map("github_syncs")
}

model ContributorStats {
  id             String      @id @default(cuid())
  projectId      String      @map("project_id")
  project        Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  githubUsername  String      @map("github_username")
  period         StatsPeriod
  commits        Int         @default(0)
  prsOpened      Int         @default(0) @map("prs_opened")
  prsMerged      Int         @default(0) @map("prs_merged")
  reviewsDone    Int         @default(0) @map("reviews_done")
  additions      Int         @default(0)
  deletions           Int    @default(0)
  avgWeeklyCommits    Float  @default(0) @map("avg_weekly_commits")
  recentWeeklyCommits Float  @default(0) @map("recent_weekly_commits")
  trend               Trend  @default(stable)
  avgWeeklyReviews    Float  @default(0) @map("avg_weekly_reviews")
  recentWeeklyReviews Float  @default(0) @map("recent_weekly_reviews")
  reviewTrend         Trend  @default(stable) @map("review_trend")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@unique([projectId, githubUsername, period])
  @@index([projectId])
  @@map("contributor_stats")
}

model MeetingTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  content     Json     @default("{}")
  authorId    String   @map("author_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  meetings Meeting[]

  @@map("meeting_templates")
}

model Meeting {
  id         String            @id @default(cuid())
  date       DateTime
  content    Json              @default("{}")
  authorId   String            @map("author_id")
  personId   String            @map("person_id")
  person     Person            @relation(fields: [personId], references: [id], onDelete: Cascade)
  templateId String?           @map("template_id")
  template   MeetingTemplate?  @relation(fields: [templateId], references: [id], onDelete: SetNull)
  createdAt  DateTime          @default(now()) @map("created_at")
  updatedAt  DateTime          @updatedAt @map("updated_at")

  @@index([personId])
  @@map("meetings")
}

model MeetingVisibilityGrant {
  id        String   @id @default(cuid())
  granterId String   @map("granter_id")
  granter   Person   @relation("GrantedVisibility", fields: [granterId], references: [id], onDelete: Cascade)
  granteeId String   @map("grantee_id")
  grantee   Person   @relation("ReceivedVisibility", fields: [granteeId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([granterId, granteeId])
  @@map("meeting_visibility_grants")
}

model PersonComment {
  id             String   @id @default(cuid())
  content        String
  personId       String   @map("person_id")
  person         Person   @relation("PersonComments", fields: [personId], references: [id], onDelete: Cascade)
  authorId       String   @map("author_id")
  authorPersonId String   @map("author_person_id")
  author         Person   @relation("PersonCommentAuthors", fields: [authorPersonId], references: [id], onDelete: Cascade)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([personId])
  @@map("person_comments")
}

model PersonGoal {
  id          String        @id @default(cuid())
  personId    String        @map("person_id")
  person      Person        @relation(fields: [personId], references: [id], onDelete: Cascade)
  title       String
  description String?
  status      RoadmapStatus @default(NOT_STARTED)
  targetDate  DateTime?     @map("target_date")
  quarter     String?
  sortOrder   Int           @default(0) @map("sort_order")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  @@index([personId])
  @@map("person_goals")
}

model PersonAccomplishment {
  id          String    @id @default(cuid())
  personId    String    @map("person_id")
  person      Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  title       String
  description String?
  date        DateTime?
  sortOrder   Int       @default(0) @map("sort_order")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([personId])
  @@map("person_accomplishments")
}

model MilestoneAssignment {
  id          String    @id @default(cuid())
  milestoneId String    @map("milestone_id")
  milestone   Milestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  personId    String    @map("person_id")
  person      Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now()) @map("created_at")

  @@unique([milestoneId, personId])
  @@map("milestone_assignments")
}

model QuarterlyGoalAssignment {
  id              String        @id @default(cuid())
  quarterlyGoalId String        @map("quarterly_goal_id")
  quarterlyGoal   QuarterlyGoal @relation(fields: [quarterlyGoalId], references: [id], onDelete: Cascade)
  personId        String        @map("person_id")
  person          Person        @relation(fields: [personId], references: [id], onDelete: Cascade)
  createdAt       DateTime      @default(now()) @map("created_at")

  @@unique([quarterlyGoalId, personId])
  @@map("quarterly_goal_assignments")
}

model KeyResult {
  id              String         @id @default(cuid())
  title           String
  targetValue     Float          @map("target_value")
  currentValue    Float          @default(0) @map("current_value")
  unit            String?
  status          RoadmapStatus  @default(NOT_STARTED)
  sortOrder       Int            @default(0) @map("sort_order")
  milestoneId     String?        @map("milestone_id")
  milestone       Milestone?     @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  quarterlyGoalId String?        @map("quarterly_goal_id")
  quarterlyGoal   QuarterlyGoal? @relation(fields: [quarterlyGoalId], references: [id], onDelete: Cascade)
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@map("key_results")
}

model PendingInvite {
  id        String   @id @default(cuid())
  email     String   @unique
  personId  String   @map("person_id")
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("pending_invites")
}

model FavoriteProject {
  id        String   @id @default(cuid())
  personId  String   @map("person_id")
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  projectId String   @map("project_id")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([personId, projectId])
  @@index([personId])
  @@index([projectId])
  @@map("favorite_projects")
}

model ProjectOwner {
  id        String   @id @default(cuid())
  personId  String   @map("person_id")
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  projectId String   @map("project_id")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([personId, projectId])
  @@index([personId])
  @@index([projectId])
  @@map("project_owners")
}
